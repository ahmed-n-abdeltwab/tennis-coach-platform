name: PR - Comprehensive Report

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  actions: read
  checks: read

jobs:
  comprehensive-report:
    name: Generate Comprehensive PR Report
    runs-on: ubuntu-latest
    # Wait for CI to complete before running
    needs: []

    steps:
      - name: Get PR number
        id: pr
        run: |
          echo "number=${{ github.event.number }}" >> $GITHUB_OUTPUT

      - name: Checkout PR code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "10"
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Set up Nx SHAs for affected detection
        uses: nrwl/nx-set-shas@v4

      - name: Get affected projects
        id: affected
        run: |
          set -e

          AFFECTED_APPS=$(pnpm exec nx show projects --affected --type app 2>/dev/null || true)
          AFFECTED_LIBS=$(pnpm exec nx show projects --affected --type lib 2>/dev/null || true)

          APP_COUNT=0
          LIB_COUNT=0

          if [ -n "$AFFECTED_APPS" ]; then
            APP_COUNT=$(echo "$AFFECTED_APPS" | grep -c . || echo 0)
          fi

          if [ -n "$AFFECTED_LIBS" ]; then
            LIB_COUNT=$(echo "$AFFECTED_LIBS" | grep -c . || echo 0)
          fi

          TOTAL_COUNT=$((APP_COUNT + LIB_COUNT))

          echo "total=$TOTAL_COUNT" >> $GITHUB_OUTPUT
          echo "apps=$APP_COUNT" >> $GITHUB_OUTPUT
          echo "libs=$LIB_COUNT" >> $GITHUB_OUTPUT

          # Save for later
          echo "$AFFECTED_APPS" > affected_apps.txt
          echo "$AFFECTED_LIBS" > affected_libs.txt

      - name: Download test artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: test-reports-*
          merge-multiple: true
          path: test-reports
        continue-on-error: true

      - name: Wait for all CI checks to complete
        id: tests
        run: |
          echo "Waiting for CI checks to complete..."

          MAX_WAIT=1800  # 30 minutes max
          WAIT_INTERVAL=15
          ELAPSED=0

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            # Get all check runs for this commit
            RESPONSE=$(gh api repos/${{ github.repository }}/commits/${{ github.event.pull_request.head.sha }}/check-runs)

            # Get CI-related checks (exclude this workflow)
            CI_CHECKS=$(echo "$RESPONSE" | jq -r '.check_runs[] | select(.name != "Generate Comprehensive PR Report") | select(.name | test("Test -|Build|Lint|Security|Publish Test Results")) | "\(.name):\(.status):\(.conclusion)"')

            if [ -z "$CI_CHECKS" ]; then
              echo "No CI checks found yet, waiting..."
              sleep $WAIT_INTERVAL
              ELAPSED=$((ELAPSED + WAIT_INTERVAL))
              continue
            fi

            echo "Current check status:"
            echo "$CI_CHECKS"

            # Check if all are completed
            PENDING=$(echo "$CI_CHECKS" | grep -c "in_progress\|queued" || true)

            if [ "$PENDING" -eq 0 ]; then
              echo "All CI checks completed!"

              # Check for failures
              FAILURES=$(echo "$CI_CHECKS" | grep -c ":failure" || true)

              if [ "$FAILURES" -gt 0 ]; then
                echo "all_passed=false" >> $GITHUB_OUTPUT
                echo "âŒ $FAILURES check(s) failed"
              else
                echo "all_passed=true" >> $GITHUB_OUTPUT
                echo "âœ… All checks passed"
              fi

              break
            fi

            echo "Waiting for $PENDING check(s) to complete..."
            sleep $WAIT_INTERVAL
            ELAPSED=$((ELAPSED + WAIT_INTERVAL))
          done

          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "Timeout waiting for CI checks"
            echo "all_passed=unknown" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Generate comprehensive report
        id: report
        run: |
          set -e

          # Start report
          echo "# ðŸš€ PR Analysis Report" > report.md
          echo "" >> report.md

          # Overall status
          if [ "${{ steps.tests.outputs.all_passed }}" == "true" ]; then
            echo "## âœ… All Checks Passed!" >> report.md
          elif [ "${{ steps.tests.outputs.all_passed }}" == "unknown" ]; then
            echo "## â³ CI Checks Still Running" >> report.md
          else
            echo "## âš ï¸ Some Checks Failed" >> report.md
          fi
          echo "" >> report.md

          # Affected projects section
          echo "## ðŸ“¦ Affected Projects" >> report.md
          echo "" >> report.md

          TOTAL=${{ steps.affected.outputs.total }}
          if [ "$TOTAL" -eq 0 ]; then
            echo "âœ… No projects affected - changes are in non-project files" >> report.md
          else
            echo "ðŸŽ¯ **${TOTAL} project(s) affected**" >> report.md
            echo "" >> report.md

            if [ ${{ steps.affected.outputs.apps }} -gt 0 ]; then
              echo "**Applications (${{ steps.affected.outputs.apps }}):**" >> report.md
              echo '```' >> report.md
              cat affected_apps.txt >> report.md
              echo '```' >> report.md
              echo "" >> report.md
            fi

            if [ ${{ steps.affected.outputs.libs }} -gt 0 ]; then
              echo "**Libraries (${{ steps.affected.outputs.libs }}):**" >> report.md
              echo '```' >> report.md
              cat affected_libs.txt >> report.md
              echo '```' >> report.md
              echo "" >> report.md
            fi
          fi

          # Test results section
          echo "## ðŸ§ª Test Results" >> report.md
          echo "" >> report.md

          if [ "${{ steps.tests.outputs.all_passed }}" == "true" ]; then
            echo "âœ… All test suites passed" >> report.md
          elif [ "${{ steps.tests.outputs.all_passed }}" == "unknown" ]; then
            echo "â³ CI checks are still running - report will update when complete" >> report.md
          else
            echo "âŒ Some test suites failed - check CI workflow for details" >> report.md
          fi
          echo "" >> report.md

          # Coverage section
          echo "## ðŸ“Š Code Coverage" >> report.md
          echo "" >> report.md

          # Helper function for progress bar
          create_progress_bar() {
            local percentage=$1
            local filled=$(awk "BEGIN {printf \"%.0f\", $percentage / 5}")
            local empty=$((20 - filled))
            printf "["
            printf "â–ˆ%.0s" $(seq 1 $filled 2>/dev/null || echo "")
            printf "â–‘%.0s" $(seq 1 $empty 2>/dev/null || echo "")
            printf "]"
          }

          # Helper function for badge
          get_badge() {
            local coverage=$1
            if (( $(awk "BEGIN {print ($coverage >= 80)}") )); then
              echo "ðŸŸ¢"
            elif (( $(awk "BEGIN {print ($coverage >= 60)}") )); then
              echo "ðŸŸ¡"
            else
              echo "ðŸ”´"
            fi
          }

          COVERAGE_FOUND=false

          # Check each test type
          for test_type in unit integration e2e; do
            COVERAGE_FILE="test-reports/coverage/apps/api/$test_type/coverage-summary.json"

            if [ -f "$COVERAGE_FILE" ]; then
              COVERAGE_FOUND=true

              LINES=$(jq -r '.total.lines.pct' "$COVERAGE_FILE" 2>/dev/null || echo "0")
              STATEMENTS=$(jq -r '.total.statements.pct' "$COVERAGE_FILE" 2>/dev/null || echo "0")
              FUNCTIONS=$(jq -r '.total.functions.pct' "$COVERAGE_FILE" 2>/dev/null || echo "0")
              BRANCHES=$(jq -r '.total.branches.pct' "$COVERAGE_FILE" 2>/dev/null || echo "0")

              BADGE=$(get_badge "$LINES")

              echo "<details>" >> report.md
              echo "<summary>$BADGE <b>${test_type^} Tests - ${LINES}% Coverage</b></summary>" >> report.md
              echo "" >> report.md
              echo "| Metric | Coverage | Progress |" >> report.md
              echo "|--------|----------|----------|" >> report.md
              echo "| Lines | ${LINES}% | $(create_progress_bar $LINES) |" >> report.md
              echo "| Statements | ${STATEMENTS}% | $(create_progress_bar $STATEMENTS) |" >> report.md
              echo "| Functions | ${FUNCTIONS}% | $(create_progress_bar $FUNCTIONS) |" >> report.md
              echo "| Branches | ${BRANCHES}% | $(create_progress_bar $BRANCHES) |" >> report.md
              echo "" >> report.md
              echo "</details>" >> report.md
              echo "" >> report.md
            fi
          done

          if [ "$COVERAGE_FOUND" = false ]; then
            echo "â„¹ï¸ Coverage reports will be available after all tests complete" >> report.md
            echo "" >> report.md
          else
            echo "### ðŸŽ¯ Coverage Targets" >> report.md
            echo "" >> report.md
            echo "- ðŸŸ¢ **Good**: â‰¥ 80%" >> report.md
            echo "- ðŸŸ¡ **Fair**: 60-79%" >> report.md
            echo "- ðŸ”´ **Needs Improvement**: < 60%" >> report.md
            echo "" >> report.md
          fi

          # Build info
          echo "## ðŸ—ï¸ Build Information" >> report.md
          echo "" >> report.md
          echo "- **PR**: #${{ steps.pr.outputs.number }}" >> report.md
          echo "- **Branch**: \`${{ github.head_ref }}\`" >> report.md
          echo "- **Commit**: \`${{ github.event.pull_request.head.sha }}\`" >> report.md
          echo "" >> report.md

          # Quick actions
          echo "## ðŸ”— Quick Actions" >> report.md
          echo "" >> report.md
          echo "- [View All Checks](https://github.com/${{ github.repository }}/pull/${{ steps.pr.outputs.number }}/checks)" >> report.md
          echo "- [View Changes](https://github.com/${{ github.repository }}/pull/${{ steps.pr.outputs.number }}/files)" >> report.md
          echo "- [View This Report Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> report.md
          echo "" >> report.md

          # Tips section
          echo "<details>" >> report.md
          echo "<summary>ðŸ’¡ <b>Tips for local development</b></summary>" >> report.md
          echo "" >> report.md
          echo "- See affected projects: \`pnpm exec nx show projects --affected\`" >> report.md
          echo "- Run affected tests: \`pnpm exec nx affected -t test\`" >> report.md
          echo "- View dependency graph: \`pnpm exec nx graph --affected\`" >> report.md
          echo "- Run with coverage: \`pnpm exec nx run api:test:unit -- --coverage\`" >> report.md
          echo "" >> report.md
          echo "</details>" >> report.md
          echo "" >> report.md

          # Footer
          echo "---" >> report.md
          echo "_ðŸ¤– Generated by PR Analysis Bot â€¢ [Powered by GitHub Actions](https://github.com/features/actions)_" >> report.md

          # Save to summary
          cat report.md > $GITHUB_STEP_SUMMARY

      - name: Comment PR
        if: steps.pr.outputs.number != ''
        uses: thollander/actions-comment-pull-request@v3
        with:
          file-path: report.md
          comment-tag: comprehensive-pr-report
          mode: recreate
          pr-number: ${{ steps.pr.outputs.number }}
