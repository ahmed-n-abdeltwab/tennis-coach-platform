name: PR - Comprehensive Report

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  actions: read
  checks: read

jobs:
  comprehensive-report:
    name: Generate Comprehensive PR Report
    runs-on: ubuntu-latest
    # Wait for CI to complete before running
    needs: []

    steps:
      - name: Get PR number
        id: pr
        run: |
          echo "number=${{ github.event.number }}" >> $GITHUB_OUTPUT

      - name: Checkout PR code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "10"
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Set up Nx SHAs for affected detection
        uses: nrwl/nx-set-shas@v4

      - name: Get affected projects
        id: affected
        run: |
          set -e

          AFFECTED_APPS=$(pnpm exec nx show projects --affected --type app 2>/dev/null || true)
          AFFECTED_LIBS=$(pnpm exec nx show projects --affected --type lib 2>/dev/null || true)

          APP_COUNT=0
          LIB_COUNT=0

          if [ -n "$AFFECTED_APPS" ]; then
            APP_COUNT=$(echo "$AFFECTED_APPS" | grep -c . || echo 0)
          fi

          if [ -n "$AFFECTED_LIBS" ]; then
            LIB_COUNT=$(echo "$AFFECTED_LIBS" | grep -c . || echo 0)
          fi

          TOTAL_COUNT=$((APP_COUNT + LIB_COUNT))

          echo "total=$TOTAL_COUNT" >> $GITHUB_OUTPUT
          echo "apps=$APP_COUNT" >> $GITHUB_OUTPUT
          echo "libs=$LIB_COUNT" >> $GITHUB_OUTPUT

          # Save for later
          echo "$AFFECTED_APPS" > affected_apps.txt
          echo "$AFFECTED_LIBS" > affected_libs.txt

      - name: Wait for CI to complete
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          check-name: "Test - unit"
          repo-token: ${{ github.token }}
          wait-interval: 10
        continue-on-error: true

      - name: Get CI status
        id: tests
        run: |
          # Check if all CI checks passed
          CHECKS=$(gh api repos/${{ github.repository }}/commits/${{ github.event.pull_request.head.sha }}/check-runs --jq '.check_runs[] | select(.name | startswith("Test -") or . == "Build" or . == "Lint & Format Check") | .conclusion')

          if echo "$CHECKS" | grep -q "failure"; then
            echo "all_passed=false" >> $GITHUB_OUTPUT
          else
            echo "all_passed=true" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true

      - name: Generate comprehensive report
        id: report
        run: |
          set -e

          # Start report
          echo "# ðŸš€ PR Analysis Report" > report.md
          echo "" >> report.md

          # Overall status
          if [ "${{ steps.tests.outputs.all_passed }}" == "true" ]; then
            echo "## âœ… All Checks Passed!" >> report.md
          else
            echo "## âš ï¸ Some Checks Need Attention" >> report.md
          fi
          echo "" >> report.md

          # Affected projects section
          echo "## ðŸ“¦ Affected Projects" >> report.md
          echo "" >> report.md

          TOTAL=${{ steps.affected.outputs.total }}
          if [ "$TOTAL" -eq 0 ]; then
            echo "âœ… No projects affected - changes are in non-project files" >> report.md
          else
            echo "ðŸŽ¯ **${TOTAL} project(s) affected**" >> report.md
            echo "" >> report.md

            if [ ${{ steps.affected.outputs.apps }} -gt 0 ]; then
              echo "**Applications (${{ steps.affected.outputs.apps }}):**" >> report.md
              echo '```' >> report.md
              cat affected_apps.txt >> report.md
              echo '```' >> report.md
              echo "" >> report.md
            fi

            if [ ${{ steps.affected.outputs.libs }} -gt 0 ]; then
              echo "**Libraries (${{ steps.affected.outputs.libs }}):**" >> report.md
              echo '```' >> report.md
              cat affected_libs.txt >> report.md
              echo '```' >> report.md
              echo "" >> report.md
            fi
          fi

          # Test results section
          echo "## ðŸ§ª Test Results" >> report.md
          echo "" >> report.md

          if [ "${{ steps.tests.outputs.all_passed }}" == "true" ]; then
            echo "âœ… All test suites passed" >> report.md
          else
            echo "âŒ Some test suites failed - check CI workflow for details" >> report.md
          fi
          echo "" >> report.md

          # Check for coverage in artifacts
          if [ -d "test-reports" ]; then
            echo "ðŸ“Š Coverage reports available in workflow artifacts" >> report.md
          else
            echo "â„¹ï¸ Coverage reports will be available after CI completes" >> report.md
          fi
          echo "" >> report.md

          # Build info
          echo "## ðŸ—ï¸ Build Information" >> report.md
          echo "" >> report.md
          echo "- **PR**: #${{ steps.pr.outputs.number }}" >> report.md
          echo "- **Branch**: \`${{ github.head_ref }}\`" >> report.md
          echo "- **Commit**: \`${{ github.event.pull_request.head.sha }}\`" >> report.md
          echo "" >> report.md

          # Quick actions
          echo "## ðŸ”— Quick Actions" >> report.md
          echo "" >> report.md
          echo "- [View All Checks](https://github.com/${{ github.repository }}/pull/${{ steps.pr.outputs.number }}/checks)" >> report.md
          echo "- [View Changes](https://github.com/${{ github.repository }}/pull/${{ steps.pr.outputs.number }}/files)" >> report.md
          echo "- [View This Report Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> report.md
          echo "" >> report.md

          # Tips section
          echo "<details>" >> report.md
          echo "<summary>ðŸ’¡ <b>Tips for local development</b></summary>" >> report.md
          echo "" >> report.md
          echo "- See affected projects: \`pnpm exec nx show projects --affected\`" >> report.md
          echo "- Run affected tests: \`pnpm exec nx affected -t test\`" >> report.md
          echo "- View dependency graph: \`pnpm exec nx graph --affected\`" >> report.md
          echo "- Run with coverage: \`pnpm exec nx run api:test:unit -- --coverage\`" >> report.md
          echo "" >> report.md
          echo "</details>" >> report.md
          echo "" >> report.md

          # Footer
          echo "---" >> report.md
          echo "_ðŸ¤– Generated by PR Analysis Bot â€¢ [Powered by GitHub Actions](https://github.com/features/actions)_" >> report.md

          # Save to summary
          cat report.md > $GITHUB_STEP_SUMMARY

      - name: Comment PR
        if: steps.pr.outputs.number != ''
        uses: thollander/actions-comment-pull-request@v3
        with:
          filePath: report.md
          comment_tag: comprehensive-pr-report
          mode: recreate
          pr_number: ${{ steps.pr.outputs.number }}
