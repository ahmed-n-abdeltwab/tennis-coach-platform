name: PR Test Analysis & Report

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  actions: read
  checks: read

jobs:
  analyze-and-report:
    name: Analyze Tests &enerate Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "10"
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Set up Nx SHAs for affected detection
        uses: nrwl/nx-set-shas@v4

      - name: Get affected projects
        id: affected
        run: |
          set -e

          AFFECTED_APPS=$(pnpm exec nx show projects --affected --type app 2>/dev/null || true)
          AFFECTED_LIBS=$(pnpm exec nx show projects --affected --type lib 2>/dev/null || true)

          APP_COUNT=0
          LIB_COUNT=0

          if [ -n "$AFFECTED_APPS" ]; then
            APP_COUNT=$(echo "$AFFECTED_APPS" | grep -c . || echo 0)
          fi

          if [ -n "$AFFECTED_LIBS" ]; then
            LIB_COUNT=$(echo "$AFFECTED_LIBS" | grep -c . || echo 0)
          fi

          TOTAL_COUNT=$((APP_COUNT + LIB_COUNT))

          echo "total=$TOTAL_COUNT" >> $GITHUB_OUTPUT
          echo "apps=$APP_COUNT" >> $GITHUB_OUTPUT
          echo "libs=$LIB_COUNT" >> $GITHUB_OUTPUT

          # Save for later
          echo "$AFFECTED_APPS" > affected_apps.txt
          echo "$AFFECTED_LIBS" > affected_libs.txt

      - name: Wait for CI checks
        id: ci_status
        run: |
          echo "â³ Waiting for CI checks to complete..."

          MAX_WAIT=1800  # 30 minutes
          WAIT_INTERVAL=15
          ELAPSED=0

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            RESPONSE=$(gh api repos/${{ github.repository }}/commits/${{ github.event.pull_request.head.sha }}/check-runs)
            CI_CHECKS=$(echo "$RESPONSE" | jq -r '.check_runs[] | select(.name != "Analyze Tests & Generate Report") | select(.name | test("Test -|Build|Lint|Security|Publish Test Results")) | "\(.name):\(.status):\(.conclusion)"')

            if [ -z "$CI_CHECKS" ]; then
              echo "No CI checks found yet, waiting..."
              sleep $WAIT_INTERVAL
              ELAPSED=$((ELAPSED + WAIT_INTERVAL))
              continue
            fi

            echo "Current check status:"
            echo "$CI_CHECKS"

            PENDING=$(echo "$CI_CHECKS" | grep -c "in_progress\|queued" || true)

            if [ "$PENDING" -eq 0 ]; then
              echo "âœ… All CI checks completed!"
              FAILURES=$(echo "$CI_CHECKS" | grep -c ":failure" || true)

              if [ "$FAILURES" -gt 0 ]; then
                echo "all_passed=false" >> $GITHUB_OUTPUT
              else
                echo "all_passed=true" >> $GITHUB_OUTPUT
              fi
              break
            fi

            echo "Waiting for $PENDING check(s)..."
            sleep $WAIT_INTERVAL
            ELAPSED=$((ELAPSED + WAIT_INTERVAL))
          done

          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "all_passed=unknown" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Download test artifacts from CI
        id: download
        run: |
          echo "ðŸ“¥ Downloading test artifacts from CI..."

          CI_RUN_ID=$(gh api repos/${{ github.repository }}/actions/workflows/ci.yml/runs \
            --jq ".workflow_runs[] | select(.head_sha == \"${{ github.event.pull_request.head.sha }}\") | .id" | head -1)

          if [ -n "$CI_RUN_ID" ]; then
            echo "ci_run_id=$CI_RUN_ID" >> $GITHUB_OUTPUT
            echo "Found CI run: $CI_RUN_ID"

            # Get job IDs for test links
            gh api repos/${{ github.repository }}/actions/runs/$CI_RUN_ID/jobs \
              --jq '.jobs[] | select(.name | test("Test -")) | {name: .name, id: .id}' \
              > job_info.json

            UNIT_JOB_ID=$(jq -r 'select(.name | test("unit")) | .id' job_info.json | head -1)
            INTEGRATION_JOB_ID=$(jq -r 'select(.name | test("integration")) | .id' job_info.json | head -1)
            E2E_JOB_ID=$(jq -r 'select(.name | test("e2e")) | .id' job_info.json | head -1)

            echo "unit_job_id=$UNIT_JOB_ID" >> $GITHUB_OUTPUT
            echo "integration_job_id=$INTEGRATION_JOB_ID" >> $GITHUB_OUTPUT
            echo "e2e_job_id=$E2E_JOB_ID" >> $GITHUB_OUTPUT

            # Download test artifacts
            for test_type in unit integration e2e; do
              if gh run download $CI_RUN_ID --dir ./downloaded-reports --name "test-reports-${test_type}" 2>&1; then
                echo "âœ… Downloaded test-reports-${test_type}"
              else
                echo "âš ï¸  test-reports-${test_type} not available"
              fi
            done

            # Move downloaded files to expected locations
            if [ -d "./downloaded-reports" ]; then
              mkdir -p test-reports coverage
              find ./downloaded-reports -type f -name "*.xml" -exec cp {} test-reports/ \;
              find ./downloaded-reports -type f -name "*.json" -exec cp {} test-reports/ \;
              find ./downloaded-reports -type f -name "coverage-summary.json" -exec sh -c 'mkdir -p coverage/apps/api/$(basename $(dirname {})) && cp {} coverage/apps/api/$(basename $(dirname {}))/' \;
            fi
          else
            echo "âš ï¸  No CI run found for this commit"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true

      - name: Analyze test artifacts
        id: analyze
        run: |
          echo "ðŸ” Running test artifacts analyzer..."
          node scripts/analyze-test-artifacts.js test-reports/analysis.json

          # Make analysis available as output
          if [ -f "test-reports/analysis.json" ]; then
            echo "analysis_available=true" >> $GITHUB_OUTPUT
          else
            echo "analysis_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate PR report
        id: report
        run: |
          set -e

          # Helper function to create progress bar
          create_progress_bar() {
            local pct=$1
            local filled=$(awk "BEGIN {print int($pct / 5)}")
            local empty=$((20 - filled))
            printf "[%s%s]" "$(printf 'â–ˆ%.0s' $(seq 1 $filled))" "$(printf 'â–‘%.0s' $(seq 1 $empty))"
          }

          echo "# ðŸš€ PR Analysis Report" > report.md
          echo "" >> report.md

          # Overall status
          if [ "${{ steps.ci_status.outputs.all_passed }}" == "true" ]; then
            echo "## âœ… All Checks Passed" >> report.md
          elif [ "${{ steps.ci_status.outputs.all_passed }}" == "unknown" ]; then
            echo "## â³ CI Checks Running" >> report.md
          else
            echo "## âš ï¸ Some Checks Failed" >> report.md
          fi
          echo "" >> report.md

          # Check if we have analysis data
          if [ "${{ steps.analyze.outputs.analysis_available }}" == "true" ]; then
            ANALYSIS_FILE="test-reports/analysis.json"
            CI_RUN_ID="${{ steps.download.outputs.ci_run_id }}"

            # Get aggregate stats
            TOTAL_TESTS=$(jq -r '.summary.aggregate.total.tests' "$ANALYSIS_FILE")
            TOTAL_PASSED=$(jq -r '.summary.aggregate.total.passed' "$ANALYSIS_FILE")
            TOTAL_FAILED=$(jq -r '.summary.aggregate.total.failed' "$ANALYSIS_FILE")
            TOTAL_SKIPPED=$(jq -r '.summary.aggregate.total.skipped' "$ANALYSIS_FILE")
            PASS_RATE=$(jq -r '.summary.aggregate.total.passRate' "$ANALYSIS_FILE")

            # Comprehensive Test & Coverage Matrix
            echo "### ðŸ“Š Comprehensive Test & Coverage Matrix" >> report.md
            echo "" >> report.md
            echo "| Suite | Tests | Pass Rate | Duration | Lines | Statements | Functions | Branches | Quality | Logs |" >> report.md
            echo "|-------|-------|-----------|----------|-------|------------|-----------|----------|---------|------|" >> report.md

            for test_type in unit integration e2e; do
              # Get test data from JSON
              HAS_DATA=$(jq -r ".testTypes.${test_type}.hasData" "$ANALYSIS_FILE")

              if [ "$HAS_DATA" == "true" ]; then
                # Get junit data
                TESTS=$(jq -r ".testTypes.${test_type}.junit.tests // 0" "$ANALYSIS_FILE")
                PASSED=$(jq -r ".testTypes.${test_type}.junit.passed // 0" "$ANALYSIS_FILE")
                FAILED=$(jq -r ".testTypes.${test_type}.junit.failures // 0" "$ANALYSIS_FILE")
                DURATION=$(jq -r ".testTypes.${test_type}.junit.time // 0" "$ANALYSIS_FILE")

                # Calculate pass rate
                if [ "$TESTS" -gt 0 ]; then
                  PASS_RATE=$(awk "BEGIN {printf \"%.1f\", ($PASSED / $TESTS) * 100}")
                else
                  PASS_RATE="N/A"
                fi

                # Get coverage data
                COV_LINES=$(jq -r ".testTypes.${test_type}.coverage.lines.pct // \"N/A\"" "$ANALYSIS_FILE")
                COV_STATEMENTS=$(jq -r ".testTypes.${test_type}.coverage.statements.pct // \"N/A\"" "$ANALYSIS_FILE")
                COV_FUNCTIONS=$(jq -r ".testTypes.${test_type}.coverage.functions.pct // \"N/A\"" "$ANALYSIS_FILE")
                COV_BRANCHES=$(jq -r ".testTypes.${test_type}.coverage.branches.pct // \"N/A\"" "$ANALYSIS_FILE")

                # Determine quality badge
                if [ "$COV_LINES" != "N/A" ]; then
                  COV_NUM=$(echo "$COV_LINES" | awk '{print int($1)}')
                  if [ "$COV_NUM" -ge 80 ]; then
                    QUALITY="ðŸŸ¢ Excellent"
                  elif [ "$COV_NUM" -ge 60 ]; then
                    QUALITY="ðŸŸ¡ Good"
                  else
                    QUALITY="ðŸ”´ Needs Work"
                  fi
                else
                  QUALITY="âšª N/A"
                fi

                # Format values
                [ "$TESTS" == "0" ] && TESTS="N/A"
                [ "$PASS_RATE" == "N/A" ] || PASS_RATE="${PASS_RATE}%"
                [ "$DURATION" == "0" ] && DURATION="N/A" || DURATION="${DURATION}s"
                [ "$COV_LINES" != "N/A" ] && COV_LINES="${COV_LINES}%"
                [ "$COV_STATEMENTS" != "N/A" ] && COV_STATEMENTS="${COV_STATEMENTS}%"
                [ "$COV_FUNCTIONS" != "N/A" ] && COV_FUNCTIONS="${COV_FUNCTIONS}%"
                [ "$COV_BRANCHES" != "N/A" ] && COV_BRANCHES="${COV_BRANCHES}%"
              else
                TESTS="N/A"
                PASS_RATE="N/A"
                DURATION="N/A"
                COV_LINES=""
                COV_STATEMENTS=""
                COV_FUNCTIONS=""
                COV_BRANCHES=""
                QUALITY="ðŸ”´ Needs Work"
                FAILED=1
              fi

              # Get job ID for link
              case "$test_type" in
                unit) JOB_ID="${{ steps.download.outputs.unit_job_id }}" ;;
                integration) JOB_ID="${{ steps.download.outputs.integration_job_id }}" ;;
                e2e) JOB_ID="${{ steps.download.outputs.e2e_job_id }}" ;;
              esac

              # Determine status link
              if [ "$TESTS" == "N/A" ] || [ "$COV_LINES" == "" ]; then
                STATUS_LINK="[âš ï¸ Partial](https://github.com/${{ github.repository }}/actions/runs/${CI_RUN_ID}/job/${JOB_ID})"
              elif [ "$FAILED" -gt 0 ]; then
                STATUS_LINK="[âŒ Failed](https://github.com/${{ github.repository }}/actions/runs/${CI_RUN_ID}/job/${JOB_ID})"
              else
                STATUS_LINK="[âœ… Passed](https://github.com/${{ github.repository }}/actions/runs/${CI_RUN_ID}/job/${JOB_ID})"
              fi

              echo "| **${test_type^}** | $TESTS | $PASS_RATE | $DURATION | $COV_LINES | $COV_STATEMENTS | $COV_FUNCTIONS | $COV_BRANCHES | $QUALITY | $STATUS_LINK |" >> report.md
            done

            echo "" >> report.md
            echo "> **Quality Legend:** ðŸŸ¢ Excellent (â‰¥80%) â€¢ ðŸŸ¡ Good (â‰¥60%) â€¢ ðŸ”´ Needs Work (<60%)" >> report.md
            echo "" >> report.md

            # Test Results Summary
            echo "### ðŸ§ª Test Results" >> report.md
            echo "" >> report.md
            echo "| Metric | Count |" >> report.md
            echo "|--------|-------|" >> report.md
            echo "| **Total Tests** | $TOTAL_TESTS |" >> report.md
            echo "| âœ… Passed | $TOTAL_PASSED |" >> report.md
            echo "| âŒ Failed | $TOTAL_FAILED |" >> report.md
            echo "| â­ï¸ Skipped | $TOTAL_SKIPPED |" >> report.md
            echo "| **Pass Rate** | ${PASS_RATE}% |" >> report.md
            echo "" >> report.md

            # Detailed breakdown for each test suite
            for test_type in unit integration e2e; do
              HAS_DATA=$(jq -r ".testTypes.${test_type}.hasData" "$ANALYSIS_FILE")

              if [ "$HAS_DATA" == "true" ]; then
                # Get job ID
                case "$test_type" in
                  unit) JOB_ID="${{ steps.outputs.unit_job_id }}" ;;
                  integration) JOB_ID="${{ steps.download.outputs.integration_job_id }}" ;;
                  e2e) JOB_ID="${{ steps.download.outputs.e2e_job_id }}" ;;
                esac

                echo "<details>" >> report.md
                echo "<summary>ðŸ§ª <b>${test_type^} Tests - Detailed Breakdown</b></summary>" >> report.md
                echo "" >> report.md

                # Test Summary Section
                TESTS=$(jq -r ".testTypes.${test_type}.junit.tests // 0" "$ANALYSIS_FILE")
                PASSED=$(jq -r ".testTypes.${test_type}.junit.passed // 0" "$ANALYSIS_FILE")
                FAILED=$(jq -r ".testTypes.${test_type}.junit.failures // 0" "$ANALYSIS_FILE")
                SKIPPED=$(jq -r ".testTypes.${test_type}.junit.skipped // 0" "$ANALYSIS_FILE")
                DURATION=$(jq -r ".testTypes.${test_type}.junit.time // 0" "$ANALYSIS_FILE")

                if [ "$TESTS" -gt 0 ]; then
                  SUITE_PASS_RATE=$(awk "BEGIN {printf \"%.1f\", ($PASSED / $TESTS) * 100}")

                  echo "## ðŸ“‹ ${test_type^} Test Summary" >> report.md
                  echo "" >> report.md
                  echo "| Metric | Count |" >> report.md
                  echo "|--------|-------|" >> report.md
                  echo "| Total Tests | $TESTS |" >> report.md
                  echo "| âœ… Passed | $PASSED |" >> report.md
                  echo "| âŒ Failed | $FAILED |" >> report.md
                  echo "| â­ï¸ Skipped | $SKIPPED |" >> report.md
                  echo "| Pass Rate | ${SUITE_PASS_RATE}% |" >> report.md
                  echo "| â±ï¸ Duration | ${DURATION}s |" >> report.md
                  echo "" >> report.md
                else
                  echo "## ðŸ“‹ ${test_type^} Test Summary" >> report.md
                  echo "" >> report.md
                  echo "âš ï¸ No test results found" >> report.md
                  echo "" >> report.md
                fi

                # Coverage Section
                COV_LINES_PCT=$(jq -r ".testTypes.${test_type}.coverage.lines.pct // null" "$ANALYSIS_FILE")

                if [ "$COV_LINES_PCT" != "null" ]; then
                  COV_LINES_COVERED=$(jq -r ".testTypes.${test_type}.coverage.lines.covered" "$ANALYSIS_FILE")
                  COV_LINES_TOTAL=$(jq -r ".testTypes.${test_type}.coverage.lines.total" "$ANALYSIS_FILE")
                  COV_STATEMENTS_PCT=$(jq -r ".testTypes.${test_type}.coverage.statements.pct" "$ANALYSIS_FILE")
                  COV_STATEMENTS_COVERED=$(jq -r ".testTypes.${test_type}.coverage.statements.covered" "$ANALYSIS_FILE")
                  COV_STATEMENTS_TOTAL=$(jq -r ".testTypes.${test_type}.coverage.statements.total" "$ANALYSIS_FILE")
                  COV_FUNCTIONS_PCT=$(jq -r ".testTypes.${test_type}.coverage.functions.pct" "$ANALYSIS_FILE")
                  COV_FUNCTIONS_COVERED=$(jq -r ".testTypes.${test_type}.coverage.functions.covered" "$ANALYSIS_FILE")
                  COV_FUNCTIONS_TOTAL=$(jq -r ".testTypes.${test_type}.coverage.functions.total" "$ANALYSIS_FILE")
                  COV_BRANCHES_PCT=$(jq -r ".testTypes.${test_type}.coverage.branches.pct" "$ANALYSIS_FILE")
                  COV_BRANCHES_COVERED=$(jq -r ".testTypes.${test_type}.coverage.branches.covered" "$ANALYSIS_FILE")
                  COV_BRANCHES_TOTAL=$(jq -r ".testTypes.${test_type}.coverage.branches.total" "$ANALYSIS_FILE")

                  # Determine badge
                  COV_NUM=$(echo "$COV_LINES_PCT" | awk '{print int($1)}')
                  if [ "$COV_NUM" -ge 80 ]; then
                    BADGE="ðŸŸ¢"
                    LABEL="Excellent"
                  elif [ "$COV_NUM" -ge 60 ]; then
                    BADGE="ðŸŸ¡"
                    LABEL="Good"
                  else
                    BADGE="ðŸ”´"
                    LABEL="Needs Work"
                  fi

                  echo "**Coverage:**" >> report.md
                  echo "- Lines: ${COV_LINES_PCT}% (${COV_LINES_COVERED}/${COV_LINES_TOTAL})" >> report.md
                  echo "- Statements: ${COV_STATEMENTS_PCT}% (${COV_STATEMENTS_COVERED}/${COV_STATEMENTS_TOTAL})" >> report.md
                  echo "- Functions: ${COV_FUNCTIONS_PCT}% (${COV_FUNCTIONS_COVERED}/${COV_FUNCTIONS_TOTAL})" >> report.md
                  echo "- Branches: ${COV_BRANCHES_PCT}% (${COV_BRANCHES_COVERED}/${COV_BRANCHES_TOTAL})" >> report.md
                  echo "" >> report.md
                  echo "---" >> report.md
                  echo "" >> report.md

                  # Coverage table with progress bars
                  echo "## $BADGE ${test_type^} Test Coverage" >> report.md
                  echo "" >> report.md
                  echo "| Metric | Coverage | Progress |" >> report.md
                  echo "|--------|----------|----------|" >> report.md
                  echo "| Lines | ${COV_LINES_PCT}% | $(create_progress_bar $COV_LINES_PCT) |" >> report.md
                  echo "| Statements | ${COV_STATEMENTS_PCT}% | $(create_progress_bar $COV_STATEMENTS_PCT) |" >> report.md
                  echo "| Functions | ${COV_FUNCTIONS_PCT}% | $(create_progress_bar $COV_FUNCTIONS_PCT) |" >> report.md
                  echo "| Branches | ${COV_BRANCHES_PCT}% | $(create_progress_bar $COV_BRANCHES_PCT) |" >> report.md
                  echo "" >> report.md
                  echo "**Coverage Details:**" >> report.md
                  echo "- âœ… Covered: ${COV_LINES_COVERED} / ${COV_LINES_TOTAL} lines" >> report.md
                  echo "- âŒ Uncovered: $((COV_LINES_TOTAL - COV_LINES_COVERED)) lines" >> report.md
                  echo "" >> report.md
                else
                  echo "---" >> report.md
                  echo "" >> report.md
                  echo "## âŒ ${test_type^} Test Coverage" >> report.md
                  echo "" >> report.md
                  echo "**Status**: Tests failed before coverage could be collected" >> report.md
                  echo "" >> report.md
                  echo "This usually means:" >> report.md
                  echo "- Tests crashed or had compilation errors" >> report.md
                  echo "- No tests were executed" >> report.md
                  echo "- Coverage collection was not enabled" >> report.md
                  echo "" >> report.md
                  echo "Check ts for more details." >> report.md
                  echo "" >> report.md
                fi

                # Link to full logs
                if [ -n "$JOB_ID" ] && [ -n "$CI_RUN_ID" ]; then
                  echo "---" >> report.md
                  echo "" >> report.md
                  echo "**ðŸ“Š Full Test Output:** [View complete ${test_type} test logs â†’](https://github.com/${{ github.repository }}/actions/runs/${CI_RUN_ID}/job/${JOB_ID})" >> report.md
                  echo "" >> report.md
                fi

                echo "</details>" >> report.md
                echo "" >> report.md
              fi
            done
          else
            echo "> âš ï¸ Test analysis data not available yet" >> report.md
            echo "" >> report.md
          fi

          # Affected projects
          TOTAL=${{ steps.affected.outputs.total }}
          if [ "$TOTAL" -gt 0 ]; then
            echo "<details>" >> report.md
            echo "<summary>ðŸ“¦ <b>Affected Projects (${TOTAL})</b></summary>" >> report.md
            echo "" >> report.md

            if [ ${{ steps.affected.outputs.apps }} -gt 0 ]; then
              echo "**Applications (${{ steps.affected.outputs.apps }}):**" >> report.md
              echo '```' >> report.md
              cat affected_apps.txt >> report.md
              echo '```' >> report.md
            fi

            if [ ${{ steps.affected.outputs.libs }} -gt 0 ]; then
              echo "**Libraries (${{ steps.affected.outputs.libs }}):**" >> report.md
              echo '```' >> report.md
              cat affected_libs.txt >> report.md
              echo '```' >> report.md
            fi

            echo "</details>" >> report.md
            echo "" >> report.md
          fi

          # Build info
          echo "---" >> report.md
          echo "" >> report.md
          echo "## ðŸ—ï¸ Build Information" >> report.md
          echo "" >> report.md
          echo "- **PR**: #${{ github.event.number }}" >> report.md
          echo "- **Branch**: \`${{ github.head_ref }}\`" >> report.md
          echo "- **Commit**: \`${{ github.event.pull_request.head.sha }}\`" >> report.md
          echo "" >> report.md

          # Quick links
          echo "## ðŸ”— Quick Actions" >> report.md
          echo "" >> report.md
          echo "- [View All Checks](https://github.com/${{ github.repository }}/pull/${{ github.event.number }}/checks)" >> report.md
          echo "- [View Changes](https://github.com/${{ github.repository }}/pull/${{ github.event.number }}/files)" >> report.md
          if [ -n "${{ steps.download.outputs.ci_run_id }}" ]; then
            echo "- [View This Report Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> report.md
          fi
          echo "" >> report.md

          # Tips section
          echo "<details>" >> report.md
          echo "<summary>ðŸ’¡ <b>Tips for local development</b></summary>" >> report.md
          echo "" >> report.md
          echo "- See affected projects: \`pnpm exec nx show projects --affected\`" >> report.md
          echo "- Run affected tests: \`pnpm exec nx affected -t test\`" >> report.md
          echo "- View dependency graph: \`pnpm exec nx graph --affected\`" >> report.md
          echo "- Run with coverage: \`pnpm exec nx run api:test:unit -- --coverage\`" >> report.md
          echo "" >> report.md
          echo "</details>" >> report.md
          echo "" >> report.md

          # Footer
          echo "---" >> report.md
          echo "_ðŸ¤– Generated by PR Analysis Bot â€¢ [Powered by GitHub Actions](https://github.com/features/actions)_" >> report.md

          cat report.md > $GITHUB_STEP_SUMMARY

      - name: Upload analysis artifact
        if: steps.analyze.outputs.analysis_available == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: test-analysis
          path: test-reports/analysis.json
          retention-days: 30

      - name: Comment on PR
        uses: thollander/actions-comment-pull-request@v3
        with:
          file-path: report.md
          comment-tag: comprehensive-pr-report
          mode: recreate
